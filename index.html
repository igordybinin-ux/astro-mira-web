<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tarot Mira</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Montserrat:wght@300;500&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0; padding: 0;
            background: radial-gradient(circle at center, #1a0b2e 0%, #000000 100%);
            color: #e0e0e0; font-family: 'Montserrat', sans-serif;
            display: flex; flex-direction: column; align-items: center;
            height: 100vh; overflow: hidden; -webkit-tap-highlight-color: transparent;
        }
        #menu-screen {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; width: 100%; position: absolute; z-index: 10;
            background: #111; transition: opacity 0.5s;
        }
        .menu-title { font-family: 'Cinzel', serif; font-size: 24px; color: #ffd700; margin-bottom: 30px; text-transform: uppercase; letter-spacing: 2px; text-align: center; }
        .menu-btn {
            background: linear-gradient(45deg, #1c1c24, #2a2a35); border: 1px solid #c5a059; color: #fff;
            padding: 15px 25px; margin: 8px; border-radius: 8px; font-family: 'Cinzel', serif; font-size: 14px;
            width: 85%; max-width: 320px; cursor: pointer; transition: transform 0.2s, background 0.3s; position: relative; 
        }
        .menu-btn:active { transform: scale(0.95); background: #c5a059; color: #000; }
        .menu-btn span { display: block; font-size: 11px; font-family: 'Montserrat', sans-serif; color: #aaa; margin-top: 4px; text-transform: none; }
        .badge {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            background: #ffd700; color: #000; padding: 3px 6px; border-radius: 4px;
            font-size: 9px; font-weight: bold; font-family: 'Montserrat', sans-serif;
        }
        .badge-free { background: #4CAF50; color: #fff; }
        .badge-sale { background: #ff4444; color: #fff; border: 1px solid #fff; }
        #gallery-screen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 100; flex-direction: column; align-items: center; }
        .gallery-header { width: 100%; padding: 15px; display: flex; justify-content: space-between; align-items: center; background: #111; border-bottom: 1px solid #c5a059; box-sizing: border-box; }
        #gallery-tabs { width: 100%; display: flex; overflow-x: auto; background: #1a1a1a; padding: 10px 0; scrollbar-width: none; }
        .tab-btn { background: none; border: none; color: #777; padding: 5px 15px; white-space: nowrap; font-family: 'Cinzel', serif; font-size: 12px; cursor: pointer; transition: 0.3s; }
        .tab-btn.active { color: #ffd700; border-bottom: 2px solid #ffd700; }
        #gallery-grid { flex: 1; width: 100%; overflow-y: auto; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px; align-content: start; box-sizing: border-box; }
        .gallery-item { width: 100%; aspect-ratio: 2/3; border-radius: 6px; overflow: hidden; border: 1px solid #c5a059; background: #111; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; }
        .gallery-item.locked img { filter: grayscale(100%) brightness(25%); }
        #card-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        #game-screen { display: none; flex-direction: column; align-items: center; width: 100%; height: 100%; padding-top: 5px; }
        h2 { font-family: 'Cinzel', serif; margin-bottom: 5px; font-weight: 400; color: #ffd700; text-transform: uppercase; letter-spacing: 2px; text-align: center; font-size: 16px; height: 25px; }
        .cards-container { display: flex; justify-content: center; align-items: center; width: 100%; height: 500px; transition: all 0.3s; }
        .cards-container.mode-five, .cards-container.mode-ten { flex-wrap: wrap; align-content: center; }
        .card-wrapper { display: flex; flex-direction: column; align-items: center; margin: 0 4px; perspective: 1000px; }
        .card { position: relative; transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: pointer; border-radius: 8px; }
        .mode-single .card { width: 240px; height: 360px; }
        .mode-triple .card { width: 100px; height: 155px; }
        .mode-five .card { width: 85px; height: 130px; }
        .mode-ten .card-wrapper { width: 31%; margin: 2px 1%; }
        .mode-ten .card { width: 100%; height: 110px; }
        .card.is-flipped { transform: rotateY(180deg); }
        .card__face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 8px; overflow: hidden; border: 2px solid #c5a059; box-sizing: border-box; background: #000; }
        .card__face--front { transform: rotateY(0deg); }
        .card__face--back { transform: rotateY(180deg); }
        .card-img-content { width: 100%; height: 100%; object-fit: cover; }
        .card-label { margin-top: 8px; text-align: center; font-size: 10px; color: #aaa; text-transform: uppercase; font-family: 'Montserrat', sans-serif; letter-spacing: 1px; height: 12px; }
        .info-block { margin-top: 5px; text-align: center; opacity: 0; transition: opacity 0.5s; height: 40px; }
        .info-block.visible { opacity: 1; }
        .card-name-text { font-family: 'Cinzel', serif; color: #ffd700; font-size: 16px; margin-bottom: 2px; }
        .card-desc-text { font-size: 11px; color: #ccc; max-width: 300px; margin: 0 auto; line-height: 1.2; }
        .action-btn { margin-top: auto; margin-bottom: 20px; padding: 12px 40px; background: linear-gradient(45deg, #c5a059, #ffd700); color: #000; border: none; border-radius: 4px; font-family: 'Cinzel', serif; font-weight: 700; font-size: 13px; opacity: 0; pointer-events: none; transition: opacity 0.5s; text-transform: uppercase; cursor: pointer; }
        .action-btn.visible { opacity: 1; pointer-events: all; }
    </style>
</head>
<body>

    <div id="menu-screen">
        <div class="menu-title" id="menu-title">Выберите расклад</div>
        
        <button class="menu-btn" onclick="startGame('single')">
            <b id="btn-single-t">Карта Дня</b>
            <span id="btn-single-d">Один совет на сегодня</span>
            <div class="badge badge-free">FREE</div>
        </button>
        
        <button class="menu-btn" onclick="startGame('triple')">
            <b id="btn-triple-t">Три Судьбы</b>
            <span id="btn-triple-d">Прошлое / Настоящее / Будущее</span>
            <div class="badge">PRO</div>
        </button>
        
        <button class="menu-btn" onclick="startGame('five')">
            <b id="btn-five-t">Подкова</b>
            <span id="btn-five-d">Скрытое и Итоги</span>
            <div class="badge">PRO</div>
        </button>
        
        <button class="menu-btn" onclick="startGame('ten')" style="border-color: #ff4444;">
            <b id="btn-ten-t">Кельтский Крест</b>
            <span id="btn-ten-d">Полный расклад (10 карт)</span>
            <div class="badge badge-sale" id="badge-sale">99₽ PRO</div>
        </button>

        <button class="menu-btn" onclick="openGallery()" style="margin-top: 20px; background: #222;">
            <b id="btn-coll-t">Коллекция Карт</b>
            <span id="btn-coll-d">Ваша энциклопедия Таро</span>
        </button>
    </div>

    <div id="gallery-screen">
        <div class="gallery-header">
            <span style="font-family:'Cinzel', serif; color:#ffd700;" id="gal-header">Коллекция</span>
            <button onclick="closeGallery()" style="background:none; border:none; color:#ffd700; font-size:24px; cursor:pointer;">✕</button>
        </div>
        <div id="gallery-tabs">
            <button class="tab-btn active" onclick="filterGallery('major', event)" id="tab-major">Старшие</button>
            <button class="tab-btn" onclick="filterGallery('wands', event)" id="tab-wands">Жезлы</button>
            <button class="tab-btn" onclick="filterGallery('cups', event)" id="tab-cups">Кубки</button>
            <button class="tab-btn" onclick="filterGallery('swords', event)" id="tab-swords">Мечи</button>
            <button class="tab-btn" onclick="filterGallery('pentacles', event)" id="tab-pent">Монеты</button>
        </div>
        <div id="gallery-grid"></div>
    </div>

    <div id="card-modal" onclick="this.style.display='none'">
        <img id="modal-img" src="" style="width:80%; max-width:280px; border-radius:10px; border:2px solid #ffd700; margin-bottom:20px;">
        <h3 id="modal-title" style="color:#ffd700; font-family:'Cinzel', serif; margin:0; text-transform:uppercase;"></h3>
        <p id="modal-desc" style="text-align:center; color:#ccc; font-size:14px; max-width:300px; line-height:1.4; margin-top:10px;"></p>
        <span style="color:#777; font-size:10px; margin-top:20px;" id="modal-close">Нажмите, чтобы закрыть</span>
    </div>

    <div id="game-screen">
        <h2 id="status-text">Коснитесь карты</h2>
        <div class="cards-container" id="cards-container"></div>
        <div class="info-block" id="info-block">
            <div class="card-name-text" id="info-name"></div>
            <div class="card-desc-text" id="info-desc"></div>
        </div>
        <button class="action-btn" id="sendBtn" onclick="sendResult()">Принять Судьбу</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const UI_TEXTS = {
            ru: {
                menu: "Выберите расклад",
                s_t: "Карта Дня", s_d: "Один совет на сегодня",
                t_t: "Три Судьбы", t_d: "Прошлое / Настоящее / Будущее",
                f_t: "Подкова", f_d: "Скрытое и Итоги",
                x_t: "Кельтский Крест", x_d: "Полный расклад (10 карт)",
                sale: "99₽ PRO",
                c_t: "Коллекция Карт", c_d: "Ваша энциклопедия Таро",
                gal: "Коллекция",
                tabs: ["Старшие", "Жезлы", "Кубки", "Мечи", "Монеты"],
                touch: "Коснитесь карты", done: "Судьба открыта", send: "Принять Судьбу",
                locked_t: "Карта скрыта", locked_d: "Эта энергия еще не проявлена. Делай расклады.", close: "Нажмите, чтобы закрыть",
                pos_3: ["Прошлое", "Настоящее", "Будущее"],
                pos_5: ["Прошлое", "Настоящее", "Будущее", "Скрытое", "Итог"],
                pos_10: ["Суть", "Проблема", "Прошлое", "Будущее", "Сознание", "Подсознание", "Совет", "Внешнее", "Страхи", "Итог"]
            },
            pt: {
                menu: "Escolha a Leitura",
                s_t: "Carta do Dia", s_d: "Um conselho para hoje",
                t_t: "Três Destinos", t_d: "Passado / Presente / Futuro",
                f_t: "Ferradura", f_d: "Oculto e Resultados",
                x_t: "Cruz Celta", x_d: "Leitura Completa (10 cartas)",
                sale: "Acesso PRO",
                c_t: "Coleção de Cartas", c_d: "Sua enciclopédia de Tarot",
                gal: "Coleção",
                tabs: ["Maiores", "Paus", "Copas", "Espadas", "Ouros"],
                touch: "Toque na carta", done: "Destino revelado", send: "Aceitar Destino",
                locked_t: "Carta oculta", locked_d: "Energia ainda não manifestada. Faça mais leituras.", close: "Toque para fechar",
                pos_3: ["Passado", "Presente", "Futuro"],
                pos_5: ["Passado", "Presente", "Futuro", "Oculto", "Resultado"],
                pos_10: ["Essência", "Desafio", "Passado", "Futuro", "Consciente", "Inconsciente", "Conselho", "Ambiente", "Esperanças", "Resultado"]
            },
            es: {
                menu: "Elige la Tirada",
                s_t: "Carta del Día", s_d: "Un consejo para hoy",
                t_t: "Tres Destinos", t_d: "Pasado / Presente / Futuro",
                f_t: "Herradura", f_d: "Oculto y Resultados",
                x_t: "Cruz Celta", x_d: "Lectura Completa (10 cartas)",
                sale: "Acceso PRO",
                c_t: "Colección de Cartas", c_d: "Tu enciclopedia de Tarot",
                gal: "Colección",
                tabs: ["Mayores", "Bastos", "Copas", "Espadas", "Oros"],
                touch: "Toca la carta", done: "Destino revelado", send: "Aceptar Destino",
                locked_t: "Carta oculta", locked_d: "Energía no manifestada aún. Haz más tiradas.", close: "Toca para cerrar",
                pos_3: ["Pasado", "Presente", "Futuro"],
                pos_5: ["Pasado", "Presente", "Futuro", "Oculto", "Resultado"],
                pos_10: ["Esencia", "Desafío", "Pasado", "Futuro", "Consciente", "Inconsciente", "Consejo", "Entorno", "Miedos", "Resultado"]
            }
        };

        const CARD_TEXTS = {
            ru: {
                fool: ["Шут", "Начало, свобода, риск."], magician: ["Маг", "Воля, мастерство."], priestess: ["Жрица", "Интуиция, тайна."],
                empress: ["Императрица", "Природа, созидание."], emperor: ["Император", "Власть, порядок."], hierophant: ["Иерофант", "Традиция, вера."],
                lovers: ["Влюбленные", "Выбор, союз."], chariot: ["Колесница", "Победа, триумф."], strength: ["Сила", "Мягкая сила, контроль."],
                hermit: ["Отшельник", "Мудрость, поиск."], fortune: ["Колесо Фортуны", "Судьба, шанс."], justice: ["Справедливость", "Закон, истина."],
                hanged: ["Повешенный", "Пауза, взгляд иначе."], death: ["Смерть", "Трансформация."], temperance: ["Умеренность", "Баланс, мера."],
                devil: ["Дьявол", "Зависимость, тень."], tower: ["Башня", "Прорыв, крах."], star: ["Звезда", "Надежда, свет."],
                moon: ["Луна", "Иллюзии, подсознание."], sun: ["Солнце", "Радость, успех."], judgement: ["Суд", "Пробуждение."], world: ["Мир", "Завершение, гармония."],
                wands: "Жезлов", cups: "Кубков", swords: "Мечей", pentacles: "Монет",
                ace: "Туз", page: "Паж", knight: "Рыцарь", queen: "Королева", king: "Король"
            },
            pt: {
                fool: ["O Louco", "Início, liberdade, risco."], magician: ["O Mago", "Vontade, maestria."], priestess: ["A Sacerdotisa", "Intuição, mistério."],
                empress: ["A Imperatriz", "Natureza, criação."], emperor: ["O Imperador", "Poder, ordem."], hierophant: ["O Hierofante", "Tradição, fé."],
                lovers: ["Os Enamorados", "Escolha, união."], chariot: ["O Carro", "Vitória, triunfo."], strength: ["A Força", "Paciência, força suave."],
                hermit: ["O Eremita", "Sabedoria, busca interior."], fortune: ["Roda da Fortuna", "Destino, mudança."], justice: ["A Justiça", "Verdade, lei."],
                hanged: ["O Enforcado", "Pausa, sacrifício."], death: ["A Morte", "Transformação."], temperance: ["A Temperança", "Equilíbrio, cura."],
                devil: ["O Diabo", "Tentação, sombra."], tower: ["A Torre", "Colapso, libertação."], star: ["A Estrela", "Esperança, luz."],
                moon: ["A Lua", "Ilusão, subconsciente."], sun: ["O Sol", "Alegria, sucesso."], judgement: ["O Julgamento", "Despertar."], world: ["O Mundo", "Harmonia, conclusão."],
                wands: "de Paus", cups: "de Copas", swords: "de Espadas", pentacles: "de Ouros",
                ace: "Ás", page: "Valete", knight: "Cavaleiro", queen: "Rainha", king: "Rei"
            },
            es: {
                fool: ["El Loco", "Inicio, libertad, riesgo."], magician: ["El Mago", "Voluntad, maestría."], priestess: ["La Sacerdotisa", "Intuición, misterio."],
                empress: ["La Emperatriz", "Naturaleza, creación."], emperor: ["El Emperador", "Poder, orden."], hierophant: ["El Hierofante", "Tradición, fe."],
                lovers: ["Los Enamorados", "Elección, unión."], chariot: ["El Carro", "Victoria, triunfo."], strength: ["La Fuerza", "Paciencia, autocontrol."],
                hermit: ["El Ermitaño", "Sabiduría, búsqueda."], fortune: ["Rueda de Fortuna", "Destino, cambio."], justice: ["La Justicia", "Verdad, ley."],
                hanged: ["El Colgado", "Pausa, sacrificio."], death: ["La Muerte", "Transformación."], temperance: ["La Templanza", "Equilibrio, armonía."],
                devil: ["El Diablo", "Tentación, sombra."], tower: ["La Torre", "Colapso, liberación."], star: ["La Estrella", "Esperanza, luz."],
                moon: ["La Luna", "Ilusión, subconsciente."], sun: ["El Sol", "Éxito, alegría."], judgement: ["El Juicio", "Despertar."], world: ["El Mundo", "Armonía, conclusión."],
                wands: "de Bastos", cups: "de Copas", swords: "de Espadas", pentacles: "de Oros",
                ace: "As", page: "Sota", knight: "Caballo", queen: "Reina", king: "Rey"
            }
        };

        const lang = new URLSearchParams(window.location.search).get('lang') || 'ru';
        const T = UI_TEXTS[lang] || UI_TEXTS['ru'];
        const C = CARD_TEXTS[lang] || CARD_TEXTS['ru'];
        
        const baseDeck = [
            {id: "fool", type: "major"}, {id: "magician", type: "major"}, {id: "priestess", type: "major"},
            {id: "empress", type: "major"}, {id: "emperor", type: "major"}, {id: "hierophant", type: "major"},
            {id: "lovers", type: "major"}, {id: "chariot", type: "major"}, {id: "strength", type: "major"},
            {id: "hermit", type: "major"}, {id: "fortune", type: "major"}, {id: "justice", type: "major"},
            {id: "hanged", type: "major"}, {id: "death", type: "major"}, {id: "temperance", type: "major"},
            {id: "devil", type: "major"}, {id: "tower", type: "major"}, {id: "star", type: "major"},
            {id: "moon", type: "major"}, {id: "sun", type: "major"}, {id: "judgement", type: "major"}, {id: "world", type: "major"}
        ];
        const suits = ["wands", "cups", "swords", "pentacles"];
        const ranks = ["ace", "2", "3", "4", "5", "6", "7", "8", "9", "10", "page", "knight", "queen", "king"];
        suits.forEach(s => ranks.forEach(r => baseDeck.push({id: `${s}_${r}`, type: s})));

        let tarotDeck = baseDeck.map(c => {
            let name, desc;
            if (c.type === 'major') {
                [name, desc] = C[c.id] || [c.id, ""];
            } else {
                let [suit, rank] = c.id.split('_');
                let rankName = C[rank] || rank;
                let suitName = C[suit] || suit;
                name = (lang === 'ru') ? `${rankName} ${suitName}` : `${rankName} ${suitName}`;
                desc = T.locked_d;
            }
            return { ...c, name: name, desc: desc };
        });

        // ПРИМЕНЕНИЕ UI
        document.getElementById('menu-title').innerText = T.menu;
        document.getElementById('btn-single-t').innerText = T.s_t; document.getElementById('btn-single-d').innerText = T.s_d;
        document.getElementById('btn-triple-t').innerText = T.t_t; document.getElementById('btn-triple-d').innerText = T.t_d;
        document.getElementById('btn-five-t').innerText = T.f_t; document.getElementById('btn-five-d').innerText = T.f_d;
        document.getElementById('btn-ten-t').innerText = T.x_t; document.getElementById('btn-ten-d').innerText = T.x_d;
        document.getElementById('badge-sale').innerText = T.sale;
        document.getElementById('btn-coll-t').innerText = T.c_t; document.getElementById('btn-coll-d').innerText = T.c_d;
        document.getElementById('gal-header').innerText = T.gal;
        document.getElementById('status-text').innerText = T.touch;
        document.getElementById('sendBtn').innerText = T.send;
        document.getElementById('modal-close').innerText = T.close;
        ['major', 'wands', 'cups', 'swords', 'pent'].forEach((id, i) => {
            const el = document.getElementById(`tab-${id}`);
            if(el) el.innerText = T.tabs[i];
        });

        function unlockCard(cardId) {
            let collection = JSON.parse(localStorage.getItem('mira_collection') || '[]');
            if (!collection.includes(cardId)) {
                collection.push(cardId);
                localStorage.setItem('mira_collection', JSON.stringify(collection));
            }
        }

        function isCardUnlocked(cardId) {
            return JSON.parse(localStorage.getItem('mira_collection') || '[]').includes(cardId);
        }

        function openGallery() {
            document.getElementById('gallery-screen').style.display = 'flex';
            filterGallery('major'); 
        }

        function closeGallery() { document.getElementById('gallery-screen').style.display = 'none'; }

        function filterGallery(type, event) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            if (event) event.target.classList.add('active');
            else {
                const el = document.getElementById(`tab-${type === 'pentacles' ? 'pent' : type}`);
                if(el) el.classList.add('active');
            }
            const grid = document.getElementById('gallery-grid');
            grid.innerHTML = '';
            tarotDeck.filter(c => c.type === type).forEach(card => {
                const unlocked = isCardUnlocked(card.id);
                const item = document.createElement('div');
                item.className = 'gallery-item' + (unlocked ? '' : ' locked');
                item.onclick = () => showCardDetail(card, unlocked);
                item.innerHTML = `<img src="cards/${card.id}.jpg">`;
                grid.appendChild(item);
            });
        }

        function showCardDetail(card, unlocked) {
            const modalImg = document.getElementById('modal-img');
            modalImg.src = `cards/${card.id}.jpg`;
            modalImg.style.filter = unlocked ? 'none' : 'grayscale(100%) brightness(25%)';
            document.getElementById('modal-title').innerText = unlocked ? card.name : T.locked_t;
            document.getElementById('modal-desc').innerText = unlocked ? card.desc : T.locked_d;
            document.getElementById('card-modal').style.display = 'flex';
        }

        let currentMode = 'single', selectedCards = [], flippedCount = 0;

        function startGame(mode) {
            currentMode = mode;
            document.getElementById('menu-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('menu-screen').style.display = 'none';
                document.getElementById('game-screen').style.display = 'flex';
                initBoard();
            }, 500);
        }

        function initBoard() {
            const container = document.getElementById('cards-container');
            container.innerHTML = ''; flippedCount = 0; selectedCards = [];
            const shuffled = [...tarotDeck].sort(() => 0.5 - Math.random());
            container.className = `cards-container mode-${currentMode}`;
            let count = (currentMode === 'single' ? 1 : (currentMode === 'triple' ? 3 : (currentMode === 'five' ? 5 : 10)));
            let labels = (currentMode === 'triple' ? T.pos_3 : (currentMode === 'five' ? T.pos_5 : T.pos_10));

            for (let i = 0; i < count; i++) {
                const cardData = shuffled[i];
                selectedCards.push(cardData);
                const wrapper = document.createElement('div');
                wrapper.className = 'card-wrapper';
                const cardEl = document.createElement('div');
                cardEl.className = 'card';
                cardEl.onclick = () => flipCardLogic(cardEl, cardData);
                cardEl.innerHTML = `
                    <div class="card__face card__face--front"><img src="cards/back.jpg" class="card-img-content"></div>
                    <div class="card__face card__face--back"><img src="cards/${cardData.id}.jpg" class="card-img-content"></div>
                `;
                wrapper.appendChild(cardEl);
                if (currentMode !== 'single') {
                    const labelEl = document.createElement('div');
                    labelEl.className = 'card-label';
                    labelEl.innerText = labels[i];
                    wrapper.appendChild(labelEl);
                }
                container.appendChild(wrapper);
            }
        }

        function flipCardLogic(element, data) {
            if (element.classList.contains('is-flipped')) return;
            element.classList.add('is-flipped');
            flippedCount++;
            unlockCard(data.id);
            if (currentMode === 'single') {
                document.getElementById('status-text').innerText = T.done;
                document.getElementById('info-name').innerText = data.name;
                document.getElementById('info-desc').innerText = data.desc;
                document.getElementById('info-block').classList.add('visible');
            } else if (flippedCount === selectedCards.length) {
                document.getElementById('status-text').innerText = T.done;
            }
            if (flippedCount === selectedCards.length) {
                setTimeout(() => { document.getElementById('sendBtn').classList.add('visible'); }, 600);
            }
        }

        function sendResult() {
            const btn = document.getElementById('sendBtn');
            btn.style.opacity = "0.7";
            let labels = (currentMode === 'triple' ? T.pos_3 : (currentMode === 'five' ? T.pos_5 : T.pos_10));
            let dataToSend = (currentMode === 'single') ? 
                { type: "tarot_result", card_name: selectedCards[0].name, card_id: selectedCards[0].id } :
                { type: "tarot_spread_" + (currentMode === 'triple' ? "3" : (currentMode === 'five' ? "5" : "10")), 
                  cards: selectedCards.map((c, i) => ({ name: c.name, id: c.id, position: labels[i] })) };
            
            tg.sendData(JSON.stringify(dataToSend));
            setTimeout(() => { tg.close(); }, 300);
        }
    </script>
</body>
</html>