<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tarot Mira</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Montserrat:wght@300;500&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0; padding: 0;
            background: radial-gradient(circle at center, #1a0b2e 0%, #000000 100%);
            color: #e0e0e0; font-family: 'Montserrat', sans-serif;
            display: flex; flex-direction: column; align-items: center;
            height: 100vh; overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- МЕНЮ --- */
        #menu-screen {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; width: 100%; position: absolute; z-index: 10;
            background: #111; transition: opacity 0.5s;
        }
        
        .menu-title {
            font-family: 'Cinzel', serif; font-size: 24px; color: #ffd700;
            margin-bottom: 30px; text-transform: uppercase; letter-spacing: 2px; text-align: center;
        }

        .menu-btn {
            background: linear-gradient(45deg, #1c1c24, #2a2a35);
            border: 1px solid #c5a059; color: #fff;
            padding: 15px 25px; margin: 8px; border-radius: 8px;
            font-family: 'Cinzel', serif; font-size: 14px;
            width: 85%; max-width: 320px; cursor: pointer;
            transition: transform 0.2s, background 0.3s;
            position: relative; 
        }
        .menu-btn:active { transform: scale(0.95); background: #c5a059; color: #000; }
        .menu-btn span { display: block; font-size: 11px; font-family: 'Montserrat', sans-serif; color: #aaa; margin-top: 4px; text-transform: none; }

        /* БЭЙДЖИ */
        .badge {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            background: #ffd700; color: #000; padding: 3px 6px; border-radius: 4px;
            font-size: 9px; font-weight: bold; font-family: 'Montserrat', sans-serif;
        }
        .badge-free { background: #4CAF50; color: #fff; }
        .badge-sale { background: #ff4444; color: #fff; border: 1px solid #fff; }

        /* --- ГАЛЕРЕЯ (СТИЛИ) --- */
        #gallery-screen {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100; flex-direction: column; align-items: center;
        }
        .gallery-header {
            width: 100%; padding: 15px; display: flex; justify-content: space-between;
            align-items: center; background: #111; border-bottom: 1px solid #c5a059; box-sizing: border-box;
        }
        #gallery-tabs {
            width: 100%; display: flex; overflow-x: auto; background: #1a1a1a; padding: 10px 0;
            scrollbar-width: none; /* Убирает скроллбар в Firefox */
        }
        #gallery-tabs::-webkit-scrollbar { display: none; } /* Убирает скроллбар в Chrome */
        .tab-btn {
            background: none; border: none; color: #777; padding: 5px 15px; white-space: nowrap;
            font-family: 'Cinzel', serif; font-size: 12px; cursor: pointer; transition: 0.3s;
        }
        .tab-btn.active { color: #ffd700; border-bottom: 2px solid #ffd700; }
        #gallery-grid {
            flex: 1; width: 100%; overflow-y: auto; display: grid;
            grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px;
            align-content: start; box-sizing: border-box;
        }
        .gallery-item { width: 100%; aspect-ratio: 2/3; border-radius: 4px; overflow: hidden; border: 1px solid #333; }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; }

        /* МОДАЛКА */
        #card-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 200; flex-direction: column;
            align-items: center; justify-content: center; padding: 20px; box-sizing: border-box;
        }

        /* --- ИГРОВОЕ ПОЛЕ --- */
        #game-screen {
            display: none; flex-direction: column; align-items: center;
            width: 100%; height: 100%; padding-top: 5px;
        }

        h2 { 
            font-family: 'Cinzel', serif; margin-bottom: 5px; font-weight: 400; 
            color: #ffd700; text-transform: uppercase; letter-spacing: 2px; 
            text-align: center; font-size: 16px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3); height: 25px;
        }

        .cards-container {
            display: flex; justify-content: center; align-items: center;
            width: 100%; height: 500px; transition: all 0.3s;
        }
        .cards-container.mode-five, .cards-container.mode-ten { flex-wrap: wrap; align-content: center; }
        .card-wrapper { display: flex; flex-direction: column; align-items: center; margin: 0 4px; perspective: 1000px; }
        .card {
            position: relative; transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            border-radius: 8px;
        }

        .mode-single .card { width: 240px; height: 360px; }
        .mode-triple .card { width: 100px; height: 155px; }
        .mode-five .card { width: 85px; height: 130px; }
        .mode-five .card-wrapper { margin: 5px 8px; }

        .mode-ten .card-wrapper { width: 31%; margin: 2px 1%; }
        .mode-ten .card { width: 100%; height: 110px; border-radius: 5px; }
        .mode-ten .card-label { font-size: 8px; margin-top: 2px; height: 10px; max-width: 100%; }

        @media (max-width: 340px) { 
            .mode-triple .card { width: 85px; height: 130px; } 
            .mode-five .card { width: 70px; height: 110px; }
            .mode-ten .card { height: 90px; }
        }

        .card.is-flipped { transform: rotateY(180deg); }
        .card__face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            border-radius: 8px; overflow: hidden; border: 2px solid #c5a059;
            box-sizing: border-box; background: #000;
        }
        .mode-ten .card__face { border-radius: 5px; border-width: 1px; }
        .card__face--front { transform: rotateY(0deg); }
        .card__face--back { transform: rotateY(180deg); }
        .card-img-content { width: 100%; height: 100%; object-fit: cover; }

        .card-label {
            margin-top: 8px; text-align: center; font-size: 10px; color: #aaa;
            text-transform: uppercase; font-family: 'Montserrat', sans-serif;
            letter-spacing: 1px; height: 12px;
        }
        .info-block { margin-top: 5px; text-align: center; opacity: 0; transition: opacity 0.5s; height: 40px; }
        .info-block.visible { opacity: 1; }
        .card-name-text { font-family: 'Cinzel', serif; color: #ffd700; font-size: 16px; margin-bottom: 2px; }
        .card-desc-text { font-size: 11px; color: #ccc; max-width: 300px; margin: 0 auto; line-height: 1.2; }

        .action-btn {
            margin-top: auto; margin-bottom: 20px; padding: 12px 40px;
            background: linear-gradient(45deg, #c5a059, #ffd700); color: #000;
            border: none; border-radius: 4px; font-family: 'Cinzel', serif;
            font-weight: 700; font-size: 13px; opacity: 0; pointer-events: none;
            transition: opacity 0.5s; text-transform: uppercase;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); cursor: pointer;
        }
        .action-btn.visible { opacity: 1; pointer-events: all; }
    </style>
</head>
<body>

    <div id="menu-screen">
        <div class="menu-title">Выберите расклад</div>
        
        <button class="menu-btn" onclick="startGame('single')">
            Карта Дня
            <span>Один совет на сегодня</span>
            <div class="badge badge-free">FREE</div>
        </button>
        
        <button class="menu-btn" onclick="startGame('triple')">
            Три Судьбы
            <span>Прошлое / Настоящее / Будущее</span>
            <div class="badge">PRO</div>
        </button>
        
        <button class="menu-btn" onclick="startGame('five')">
            Подкова (5 карт)
            <span>Скрытое и Итоги</span>
            <div class="badge">PRO</div>
        </button>
        
        <button class="menu-btn" onclick="startGame('ten')" style="border-color: #ff4444; box-shadow: 0 0 10px rgba(255,68,68,0.2);">
            Кельтский Крест
            <span>Полный расклад (10 карт)</span>
            <div class="badge badge-sale">290₽ | 99₽ PRO</div>
        </button>

        <button class="menu-btn" onclick="openGallery()" style="margin-top: 20px; background: #222; border-color: #777;">
            Коллекция Карт
            <span>Ваша энциклопедия Таро</span>
        </button>
    </div>

    <div id="gallery-screen">
        <div class="gallery-header">
            <span style="font-family:'Cinzel', serif; color:#ffd700;">Коллекция</span>
            <button onclick="closeGallery()" style="background:none; border:none; color:#ffd700; font-size:24px; cursor:pointer;">✕</button>
        </div>
        <div id="gallery-tabs">
            <button class="tab-btn active" onclick="filterGallery('major', event)">Старшие</button>
            <button class="tab-btn" onclick="filterGallery('wands', event)">Жезлы</button>
            <button class="tab-btn" onclick="filterGallery('cups', event)">Кубки</button>
            <button class="tab-btn" onclick="filterGallery('swords', event)">Мечи</button>
            <button class="tab-btn" onclick="filterGallery('pentacles', event)">Монеты</button>
        </div>
        <div id="gallery-grid"></div>
    </div>

    <div id="card-modal" onclick="this.style.display='none'">
        <img id="modal-img" src="" style="width:80%; max-width:280px; border-radius:10px; border:2px solid #ffd700; margin-bottom:20px;">
        <h3 id="modal-title" style="color:#ffd700; font-family:'Cinzel', serif; margin:0; text-transform:uppercase;"></h3>
        <p id="modal-desc" style="text-align:center; color:#ccc; font-size:14px; max-width:300px; line-height:1.4; margin-top:10px;"></p>
        <span style="color:#777; font-size:10px; margin-top:20px;">Нажмите, чтобы закрыть</span>
    </div>

    <div id="game-screen">
        <h2 id="status-text">Коснитесь карты</h2>
        <div class="cards-container" id="cards-container"></div>
        <div class="info-block" id="info-block">
            <div class="card-name-text" id="info-name"></div>
            <div class="card-desc-text" id="info-desc"></div>
        </div>
        <button class="action-btn" id="sendBtn" onclick="sendResult()">Принять Судьбу</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand(); 

        const tarotDeck = [
            // Старшие Арканы
            {name: "Шут", id: "fool", type: "major", desc: "Начало пути, свобода, риск и вера в чудо."},
            {name: "Маг", id: "magician", type: "major", desc: "Воля, мастерство, способность манипулировать реальностью."},
            {name: "Жрица", id: "priestess", type: "major", desc: "Интуиция, тайны, глубокое подсознательное знание."},
            {name: "Императрица", id: "empress", type: "major", desc: "Плодородие, творчество, изобилие и природа."},
            {name: "Император", id: "emperor", type: "major", desc: "Власть, структура, контроль и стабильность."},
            {name: "Иерофант", id: "hierophant", type: "major", desc: "Традиция, вера, обучение и духовный авторитет."},
            {name: "Влюбленные", id: "lovers", type: "major", desc: "Выбор сердца, союз, гармония отношений."},
            {name: "Колесница", id: "chariot", type: "major", desc: "Победа через волю, контроль над противоречиями."},
            {name: "Сила", id: "strength", type: "major", desc: "Мягкая сила, терпение, покорение страстей."},
            {name: "Отшельник", id: "hermit", type: "major", desc: "Мудрость, уединение, поиск внутреннего света."},
            {name: "Колесо Фортуны", id: "fortune", type: "major", desc: "Судьба, удача, циклы перемен."},
            {name: "Справедливость", id: "justice", type: "major", desc: "Правда, закон, объективность и карма."},
            {name: "Повешенный", id: "hanged", type: "major", desc: "Жертва ради знания, пауза, новый взгляд."},
            {name: "Смерть", id: "death", type: "major", desc: "Трансформация, конец старого, начало нового."},
            {name: "Умеренность", id: "temperance", type: "major", desc: "Баланс, исцеление, золотая середина."},
            {name: "Дьявол", id: "devil", type: "major", desc: "Зависимость, теневые стороны, материальный плен."},
            {name: "Башня", id: "tower", type: "major", desc: "Внезапный крах иллюзий, очищающий хаос."},
            {name: "Звезда", id: "star", type: "major", desc: "Надежда, вдохновение, духовное руководство."},
            {name: "Луна", id: "moon", type: "major", desc: "Иллюзии, страхи, интуитивные сны."},
            {name: "Солнце", id: "sun", type: "major", desc: "Успех, радость, ясность и жизненная сила."},
            {name: "Суд", id: "judgement", type: "major", desc: "Возрождение, призыв к действию, прощение."},
            {name: "Мир", id: "world", type: "major", desc: "Завершение цикла, гармония, триумф."},

            // Жезлы
            {name: "Туз Жезлов", id: "wands_ace", type: "wands", desc: "Импульс, творческая искра, новая идея."},
            {name: "2 Жезлов", id: "wands_2", type: "wands", desc: "Планирование, владение ситуацией, выбор пути."},
            {name: "3 Жезлов", id: "wands_3", type: "wands", desc: "Перспективы, ожидание результатов, расширение."},
            {name: "4 Жезлов", id: "wands_4", type: "wands", desc: "Праздник, стабильный успех, радость дома."},
            {name: "5 Жезлов", id: "wands_5", type: "wands", desc: "Конкуренция, борьба амбиций, споры."},
            {name: "6 Жезлов", id: "wands_6", type: "wands", desc: "Победа, признание, триумфальное возвращение."},
            {name: "7 Жезлов", id: "wands_7", type: "wands", desc: "Защита своих позиций, решительность под давлением."},
            {name: "8 Жезлов", id: "wands_8", type: "wands", desc: "Скорость, полет стрел, быстрые новости."},
            {name: "9 Жезлов", id: "wands_9", type: "wands", desc: "Последний рубеж, стойкость, опыт прошлых битв."},
            {name: "10 Жезлов", id: "wands_10", type: "wands", desc: "Тяжелое бремя, перегрузка, предел сил."},
            {name: "Паж Жезлов", id: "wands_page", type: "wands", desc: "Юношеский пыл, новости о проектах, энтузиазм."},
            {name: "Рыцарь Жезлов", id: "wands_knight", type: "wands", desc: "Напор, страсть, стремительное приключение."},
            {name: "Королева Жезлов", id: "wands_queen", type: "wands", desc: "Харизма, уверенность, энергия огня."},
            {name: "Король Жезлов", id: "wands_king", type: "wands", desc: "Лидерство, решительность, зрелое видение."},

            // Кубки
            {name: "Туз Кубков", id: "cups_ace", type: "cups", desc: "Источник чувств, любовь, вдохновение."},
            {name: "2 Кубков", id: "cups_2", type: "cups", desc: "Встреча, союз, взаимная симпатия."},
            {name: "3 Кубков", id: "cups_3", type: "cups", desc: "Дружба, праздник, радость в кругу близких."},
            {name: "4 Кубков", id: "cups_4", type: "cups", desc: "Пресыщение, апатия, незамеченный шанс."},
            {name: "5 Кубков", id: "cups_5", type: "cups", desc: "Печаль о потерянном, разочарование."},
            {name: "6 Кубков", id: "cups_6", type: "cups", desc: "Ностальгия, воспоминания, старый друг."},
            {name: "7 Кубков", id: "cups_7", type: "cups", desc: "Иллюзии, выбор из множества призрачных вариантов."},
            {name: "8 Кубков", id: "cups_8", type: "cups", desc: "Уход в поисках высшего, отказ от привычного."},
            {name: "9 Кубков", id: "cups_9", type: "cups", desc: "Исполнение желаний, довольство собой."},
            {name: "10 Кубков", id: "cups_10", type: "cups", desc: "Семейное счастье, эмоциональный триумф."},
            {name: "Паж Кубков", id: "cups_page", type: "cups", desc: "Нежные чувства, воображение, весть о любви."},
            {name: "Рыцарь Кубков", id: "cups_knight", type: "cups", desc: "Романтика, предложение, рыцарский жест."},
            {name: "Королева Кубков", id: "cups_queen", type: "cups", desc: "Интуиция, эмпатия, глубокие переживания."},
            {name: "Король Кубков", id: "cups_king", type: "cups", desc: "Зрелость чувств, поддержка, мудрость."},

            // Мечи
            {name: "Туз Мечей", id: "swords_ace", type: "swords", desc: "Ясное решение, отсечение лишнего."},
            {name: "2 Мечей", id: "swords_2", type: "swords", desc: "Тупик, закрытость, попытка найти баланс."},
            {name: "3 Мечей", id: "swords_3", type: "swords", desc: "Разбитое сердце, горькая правда."},
            {name: "4 Мечей", id: "swords_4", type: "swords", desc: "Отдых, восстановление сил, медитация."},
            {name: "5 Мечей", id: "swords_5", type: "swords", desc: "Жестокая победа, конфликт интересов."},
            {name: "6 Мечей", id: "swords_6", type: "swords", desc: "Уход от проблем, переход к спокойствию."},
            {name: "7 Мечей", id: "swords_7", type: "swords", desc: "Хитрость, тактика, уход от ответственности."},
            {name: "8 Мечей", id: "swords_8", type: "swords", desc: "Плен мыслей, самоограничения, страх действия."},
            {name: "9 Мечей", id: "swords_9", type: "swords", desc: "Тревога, бессонница, ночные кошмары."},
            {name: "10 Мечей", id: "swords_10", type: "swords", desc: "Полный крах, дно ситуации, конец мучений."},
            {name: "Паж Мечей", id: "swords_page", type: "swords", desc: "Острый ум, сбор информации, критика."},
            {name: "Рыцарь Мечей", id: "swords_knight", type: "swords", desc: "Напор, порыв, интеллектуальный штурм."},
            {name: "Королева Мечей", id: "swords_queen", type: "swords", desc: "Независимость, логика, честность."},
            {name: "Король Мечей", id: "swords_king", type: "swords", desc: "Закон, стратегия и справедливость."},

            // Монеты
            {name: "Туз Монет", id: "pentacles_ace", type: "pentacles", desc: "Материальный дар, шанс на прибыль."},
            {name: "2 Монет", id: "pentacles_2", type: "pentacles", desc: "Суета, балансировка делами, гибкость."},
            {name: "3 Монет", id: "pentacles_3", type: "pentacles", desc: "Мастерство, работа в команде."},
            {name: "4 Монет", id: "pentacles_4", type: "pentacles", desc: "Скупость, удержание накопленного, страх потерь."},
            {name: "5 Монет", id: "pentacles_5", type: "pentacles", desc: "Кризис, нехватка ресурсов, испытание."},
            {name: "6 Монет", id: "pentacles_6", type: "pentacles", desc: "Помощь, благотворительность, обмен."},
            {name: "7 Монет", id: "pentacles_7", type: "pentacles", desc: "Терпение, ожидание урожая, долгий проект."},
            {name: "8 Монет", id: "pentacles_8", type: "pentacles", desc: "Трудолюбие, оттачивание деталей, ремесло."},
            {name: "9 Монет", id: "pentacles_9", type: "pentacles", desc: "Роскошь, самодостаточность, успех."},
            {name: "10 Монет", id: "pentacles_10", type: "pentacles", desc: "Наследие, благополучие рода, стабильность."},
            {name: "Паж Монет", id: "pentacles_page", type: "pentacles", desc: "Ученичество, практические новости."},
            {name: "Рыцарь Монет", id: "pentacles_knight", type: "pentacles", desc: "Упорство, надежность, верный путь."},
            {name: "Королева Монет", id: "pentacles_queen", type: "pentacles", desc: "Практичность, забота о доме, изобилие."},
            {name: "Король Монет", id: "pentacles_king", type: "pentacles", desc: "Финансовый успех, хозяин жизни."}
        ];

        let currentMode = 'single';
        let selectedCards = []; 
        let flippedCount = 0;

        function preloadImages() {
            new Image().src = "cards/back.jpg";
            tarotDeck.forEach(card => {
                new Image().src = `cards/${card.id}.jpg`;
            });
        }
        preloadImages();

        // ФУНКЦИИ ГАЛЕРЕИ
        function openGallery() {
            document.getElementById('gallery-screen').style.display = 'flex';
            filterGallery('major'); 
        }

        function closeGallery() {
            document.getElementById('gallery-screen').style.display = 'none';
        }

        function filterGallery(type, event) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            if (event) {
                event.target.classList.add('active');
            } else {
                document.querySelector(`.tab-btn[onclick*="${type}"]`).classList.add('active');
            }

            const grid = document.getElementById('gallery-grid');
            grid.innerHTML = '';

            const filtered = tarotDeck.filter(c => c.type === type);
            filtered.forEach(card => {
                const item = document.createElement('div');
                item.className = 'gallery-item';
                item.onclick = () => showCardDetail(card);
                item.innerHTML = `<img src="cards/${card.id}.jpg">`;
                grid.appendChild(item);
            });
        }

        function showCardDetail(card) {
            document.getElementById('modal-img').src = `cards/${card.id}.jpg`;
            document.getElementById('modal-title').innerText = card.name;
            document.getElementById('modal-desc').innerText = card.desc;
            document.getElementById('card-modal').style.display = 'flex';
        }

        // ЛОГИКА ИГРЫ
        function startGame(mode) {
            currentMode = mode;
            document.getElementById('menu-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('menu-screen').style.display = 'none';
                document.getElementById('game-screen').style.display = 'flex';
                initBoard();
            }, 500);
        }

        function initBoard() {
            const container = document.getElementById('cards-container');
            container.innerHTML = '';
            flippedCount = 0;
            selectedCards = [];
            const shuffled = [...tarotDeck].sort(() => 0.5 - Math.random());
            
            container.className = 'cards-container';
            container.classList.add(`mode-${currentMode}`);

            let count = 1;
            let labels = [];

            if (currentMode === 'single') count = 1;
            else if (currentMode === 'triple') { count = 3; labels = ["Прошлое", "Настоящее", "Будущее"]; }
            else if (currentMode === 'five') { count = 5; labels = ["Прошлое", "Настоящее", "Будущее", "Скрытое", "Итог"]; }
            else if (currentMode === 'ten') { 
                count = 10; 
                labels = ["Текущее", "Проблема", "Прошлое", "Будущее", "Сознание", "Подсознание", "Совет", "Внешнее", "Страхи", "Итог"]; 
            }

            for (let i = 0; i < count; i++) {
                const cardData = shuffled[i];
                selectedCards.push(cardData);
                const wrapper = document.createElement('div');
                wrapper.className = 'card-wrapper';
                const cardEl = document.createElement('div');
                cardEl.className = 'card';
                cardEl.onclick = () => flipCardLogic(cardEl, cardData, i);
                cardEl.innerHTML = `
                    <div class="card__face card__face--front"><img src="cards/back.jpg" class="card-img-content"></div>
                    <div class="card__face card__face--back"><img src="cards/${cardData.id}.jpg" class="card-img-content"></div>
                `;
                wrapper.appendChild(cardEl);
                if (currentMode !== 'single') {
                    const labelEl = document.createElement('div');
                    labelEl.className = 'card-label';
                    labelEl.innerText = labels[i];
                    wrapper.appendChild(labelEl);
                }
                container.appendChild(wrapper);
            }
        }

        function flipCardLogic(element, data, index) {
            if (element.classList.contains('is-flipped')) return;
            element.classList.add('is-flipped');
            flippedCount++;
            if (currentMode === 'single') {
                document.getElementById('status-text').innerText = "Судьба открыта";
                document.getElementById('info-name').innerText = data.name;
                document.getElementById('info-desc').innerText = data.desc;
                document.getElementById('info-block').classList.add('visible');
            } else {
                const total = selectedCards.length;
                document.getElementById('status-text').innerText = `Открыто ${flippedCount} из ${total}`;
                if (flippedCount === total) document.getElementById('status-text').innerText = "Картина ясна";
            }
            if (flippedCount === selectedCards.length) {
                setTimeout(() => { document.getElementById('sendBtn').classList.add('visible'); }, 600);
            }
        }

        function sendResult() {
            const btn = document.getElementById('sendBtn');
            btn.innerText = "Отправка...";
            btn.style.opacity = "0.7";
            let dataToSend = {};
            try {
                if (currentMode === 'single') {
                    dataToSend = { type: "tarot_result", card_name: selectedCards[0].name, card_id: selectedCards[0].id };
                } else {
                    let type = "tarot_spread_" + (currentMode === 'triple' ? "3" : (currentMode === 'five' ? "5" : "10"));
                    let labels = currentMode === 'triple' ? ["Прошлое", "Настоящее", "Будущее"] : 
                                (currentMode === 'five' ? ["Прошлое", "Настоящее", "Будущее", "Скрытое", "Итог"] : 
                                ["Текущее", "Проблема", "Прошлое", "Будущее", "Сознание", "Подсознание", "Совет", "Внешнее", "Страхи", "Итог"]);
                    dataToSend = {
                        type: type,
                        cards: selectedCards.map((c, i) => ({ name: c.name, id: c.id, position: labels[i] }))
                    };
                }
                tg.sendData(JSON.stringify(dataToSend));
                setTimeout(() => { tg.close(); }, 300);
            } catch (e) {
                alert("Ошибка отправки: " + e.message);
                btn.innerText = "Попробовать снова";
                btn.style.opacity = "1";
            }
        }
    </script>
</body>
</html>