<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Профиль MIRA</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color, #1a1a1a);
            color: var(--tg-theme-text-color, #ffffff);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 12px;
            border: 1px solid #444;
            background-color: var(--tg-theme-secondary-bg-color, #2c2c2c);
            color: var(--tg-theme-text-color, #ffffff);
            font-size: 16px;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 15px;
            margin-top: 20px;
            border-radius: 12px;
            border: none;
            background-color: var(--tg-theme-button-color, #8a2be2);
            color: var(--tg-theme-button-text-color, #ffffff);
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        label {
            align-self: flex-start;
            font-size: 14px;
            color: #888;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <label>Имя</label>
    <input type="text" id="name" placeholder="Твое имя">

    <label>Дата рождения</label>
    <input type="date" id="birth_date">

    <label>Время рождения</label>
    <input type="time" id="birth_time">

    <label>Город рождения</label>
    <input type="text" id="city" placeholder="Например: Москва">

    <button id="btn_save">СОХРАНИТЬ</button>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();

        // 1. Парсим URL, чтобы заполнить поля текущими данными
        const urlParams = new URLSearchParams(window.location.search);
        
        if(urlParams.get('name')) document.getElementById('name').value = urlParams.get('name');
        if(urlParams.get('city') && urlParams.get('city') !== '—') document.getElementById('city').value = urlParams.get('city');
        if(urlParams.get('btime') && urlParams.get('btime') !== '—') document.getElementById('birth_time').value = urlParams.get('btime');
        
        // Обработка даты (превращаем 20.05.1990 в 1990-05-20 для поля input date)
        let rawDate = urlParams.get('bdate');
        if(rawDate && rawDate !== '—') {
            if(rawDate.includes('.')) {
                let parts = rawDate.split('.');
                // input date принимает YYYY-MM-DD
                document.getElementById('birth_date').value = `${parts[2]}-${parts[1]}-${parts[0]}`;
            } else {
                document.getElementById('birth_date').value = rawDate;
            }
        }

        // 2. Логика кнопки Сохранить
        document.getElementById('btn_save').addEventListener('click', function(){
            let name = document.getElementById('name').value;
            let bdate = document.getElementById('birth_date').value; // Формат всегда YYYY-MM-DD
            let btime = document.getElementById('birth_time').value;
            let city = document.getElementById('city').value;

            if(!name || !bdate || !city) {
                tg.showAlert("Заполни имя, дату и город!");
                return;
            }

            let data = {
                type: 'astro_profile_update',
                name: name,
                birth_date: bdate,
                birth_time: btime || "12:00",
                city: city
            };

            // ОТПРАВЛЯЕМ ДАННЫЕ БОТУ
            tg.sendData(JSON.stringify(data));
            
            // На всякий случай закрываем окно (хотя sendData обычно сам закрывает)
            setTimeout(() => { tg.close(); }, 100);
        });
    </script>
</body>
</html>